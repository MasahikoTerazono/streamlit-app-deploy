import streamlit as st
import os
import datetime

# åŸºæœ¬çš„ãªStreamlitãƒ†ã‚¹ãƒˆ
st.set_page_config(page_title="å°‚é–€å®¶LLMã‚¢ãƒ—ãƒª", layout="centered")

st.title("ğŸ§  å°‚é–€å®¶LLMã‚¢ãƒ—ãƒª")
st.markdown("**AIå°‚é–€å®¶ã«è³ªå•ã—ã¦ã€å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**")

# ã‚¢ãƒ—ãƒªã®æ¦‚è¦ã¨æ“ä½œæ–¹æ³•ã‚’è¡¨ç¤º
st.markdown("---")
st.subheader("ğŸ“– ã‚¢ãƒ—ãƒªã®æ¦‚è¦")
st.markdown("""
ã“ã®ã‚¢ãƒ—ãƒªã¯ã€**AIæŠ€è¡“ã‚’æ´»ç”¨ã—ãŸå°‚é–€å®¶ç›¸è«‡ã‚·ã‚¹ãƒ†ãƒ **ã§ã™ã€‚
æ§˜ã€…ãªåˆ†é‡ã®å°‚é–€å®¶ã¨ã—ã¦æŒ¯ã‚‹èˆã†AIã«ã€æ°—è»½ã«ç›¸è«‡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ğŸ¯ ä¸»ãªç‰¹å¾´
- ğŸ§  **å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼**: å¿ƒã®æ‚©ã¿ã‚„äººé–“é–¢ä¿‚ã«ã¤ã„ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ğŸ’° **é‡‘èã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼**: æŠ•è³‡ãƒ»è²¯è“„ãƒ»è³‡ç”£é‹ç”¨ã«é–¢ã™ã‚‹å°‚é–€çš„ãªã‚µãƒãƒ¼ãƒˆ
- ğŸš€ **ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ**: è»¢è·ãƒ»æ˜‡é€²ãƒ»ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã®å®Ÿè·µçš„ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
- ğŸ’» **ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ**: æŠ€è¡“çš„èª²é¡Œã‚„ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã¸ã®å°‚é–€çš„åŠ©è¨€
- âš•ï¸ **åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼**: å¥åº·ç®¡ç†ã‚„äºˆé˜²ã«é–¢ã™ã‚‹ä¸€èˆ¬çš„ãªæƒ…å ±æä¾›

### ğŸ“‹ æ“ä½œæ–¹æ³•
1. **å°‚é–€å®¶ã‚’é¸æŠ**: ç›¸è«‡å†…å®¹ã«é©ã—ãŸå°‚é–€å®¶ã‚’ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§é¸æŠ
2. **è³ªå•ã‚’å…¥åŠ›**: ç›¸è«‡ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨˜å…¥
3. **è³ªå•ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯**: AIãŒé¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã¨ã—ã¦å›ç­”ã‚’ç”Ÿæˆ
4. **å›ç­”ã‚’ç¢ºèª**: å°‚é–€çš„ãªè¦–ç‚¹ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘å–ã‚‹

### âš ï¸ æ³¨æ„äº‹é …
- ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯**æƒ…å ±æä¾›ã®ã¿**ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€å°‚é–€çš„ãªè¨ºæ–­ã‚„æ²»ç™‚ã®ä»£æ›¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“
- é‡è¦ãªæ±ºå®šã®å‰ã«ã¯ã€å¿…ãšå®Ÿéš›ã®å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„
- ç·Šæ€¥ã®å ´åˆã¯ã€é©åˆ‡ãªå°‚é–€æ©Ÿé–¢ã«ç›´æ¥ã”é€£çµ¡ãã ã•ã„
""")

st.markdown("---")

# ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã¨ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
with st.expander("ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ãƒ»ãƒ‡ãƒãƒƒã‚°", expanded=False):
    st.write("ğŸ“‹ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèªä¸­...")
    
    # 1. python-dotenvãƒ†ã‚¹ãƒˆ
    try:
        from dotenv import load_dotenv
        load_dotenv()
        st.success("âœ… python-dotenv: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿")
    except ImportError:
        st.error("âŒ python-dotenv: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        st.code("pip install python-dotenv")
    except Exception as e:
        st.error(f"âŒ python-dotenv: ã‚¨ãƒ©ãƒ¼ - {e}")

    # 2. langchain-openaiãƒ†ã‚¹ãƒˆ
    try:
        from langchain_openai import ChatOpenAI
        st.success("âœ… langchain-openai: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿")
    except ImportError:
        st.error("âŒ langchain-openai: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        st.code("pip install langchain-openai")
    except Exception as e:
        st.error(f"âŒ langchain-openai: ã‚¨ãƒ©ãƒ¼ - {e}")

    # 3. langchain-coreãƒ†ã‚¹ãƒˆ
    try:
        from langchain_core.messages import SystemMessage, HumanMessage
        st.success("âœ… langchain-core: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿")
    except ImportError:
        st.error("âŒ langchain-core: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        st.code("pip install langchain-core")
    except Exception as e:
        st.error(f"âŒ langchain-core: ã‚¨ãƒ©ãƒ¼ - {e}")

    st.write(f"ğŸ• ç¾åœ¨æ™‚åˆ»: {datetime.datetime.now()}")
    st.success("Streamlitã‚¢ãƒ—ãƒªã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™")

    # é–¢æ•°ä½¿ç”¨ä¾‹
    st.write("**é–¢æ•°ä½¿ç”¨ä¾‹:**")
    st.code("""
# ä½¿ç”¨ä¾‹ï¼š
response = get_expert_response(
    user_input="è»¢è·ã‚’è€ƒãˆã¦ã„ã‚‹ã®ã§ã™ãŒ...", 
    expert_type="ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ", 
    api_key=your_api_key
)
print(response)  # LLMã‹ã‚‰ã®å›ç­”ãŒè¿”ã•ã‚Œã‚‹
    """)
    st.write("**é–¢æ•°ã®ä»•æ§˜:**")
    st.write("- å¼•æ•°: `user_input` (str), `expert_type` (str), `api_key` (str)")
    st.write("- æˆ»ã‚Šå€¤: LLMã‹ã‚‰ã®å›ç­” (str)")
    st.write("- ä¾‹å¤–: ImportError, Exception")

# APIã‚­ãƒ¼è¨­å®šçŠ¶æ³
st.subheader("ğŸ”‘ APIè¨­å®šçŠ¶æ³")

# Streamlit Community Cloudç”¨ã®ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
api_key = None

# 1. Streamlit Secretsã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆCommunity Cloudç”¨ï¼‰
if hasattr(st, 'secrets') and 'OPENAI_API_KEY' in st.secrets:
    api_key = st.secrets['OPENAI_API_KEY']
    st.info("ğŸŒ Streamlit Community Cloudç’°å¢ƒã§å‹•ä½œä¸­")

# 2. ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
if not api_key:
    api_key = os.getenv("OPENAI_API_KEY")
    if api_key:
        st.info("ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§å‹•ä½œä¸­")

if not api_key:
    st.error("âŒ OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    st.info("""
    **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã®è¨­å®šæ–¹æ³•:**
    1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã« `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
    2. ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ä»¥ä¸‹ã‚’è¨˜è¿°ï¼š
    ```
    OPENAI_API_KEY=your_actual_api_key_here
    ```
    
    **Streamlit Community Cloudã§ã®è¨­å®šæ–¹æ³•:**
    1. ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã§ "Secrets" ã‚’é–‹ã
    2. ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
    ```
    OPENAI_API_KEY = "your_actual_api_key_here"
    ```
    
    **APIã‚­ãƒ¼å–å¾—:**
    [OpenAI API Keys](https://platform.openai.com/api-keys) ã‹ã‚‰å–å¾—
    """)
    st.warning("âš ï¸ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹ã¾ã§ã€AIæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚")
else:
    st.success("âœ… OpenAI APIã‚­ãƒ¼ãŒæ­£å¸¸ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™")
    st.sidebar.success("ğŸ”‘ APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿")
    st.sidebar.write(f"ğŸ“ APIã‚­ãƒ¼ã®é•·ã•: {len(api_key)} æ–‡å­—")

st.markdown("---")

# ãƒãƒ£ãƒƒãƒˆå…¥åŠ›
st.subheader("ğŸ’¬ å°‚é–€å®¶ã¨ã®å¯¾è©±")

# å°‚é–€å®¶é¸æŠãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
expert_type = st.radio(
    "ç›¸è«‡ã—ãŸã„å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š",
    ["å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼", "é‡‘èã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼", "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ", "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ", "åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼"],
    horizontal=True
)

# é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®èª¬æ˜ã‚’è¡¨ç¤º
expert_descriptions = {
    "å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼": "ğŸ§  å¿ƒã®æ‚©ã¿ã‚„äººé–“é–¢ä¿‚ã«ã¤ã„ã¦å„ªã—ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™",
    "é‡‘èã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": "ğŸ’° æŠ•è³‡ã€è²¯è“„ã€è³‡ç”£é‹ç”¨ã«ã¤ã„ã¦å°‚é–€çš„ã«ã‚µãƒãƒ¼ãƒˆã—ã¾ã™",
    "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ": "ğŸš€ è»¢è·ã€æ˜‡é€²ã€ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã«ã¤ã„ã¦å®Ÿè·µçš„ã«ã‚¬ã‚¤ãƒ‰ã—ã¾ã™",
    "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ": "ğŸ’» æŠ€è¡“çš„ãªèª²é¡Œã‚„ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã«ã¤ã„ã¦å°‚é–€çš„ã«åŠ©è¨€ã—ã¾ã™",
    "åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": "âš•ï¸ å¥åº·ç®¡ç†ã‚„åŒ»ç™‚ã«é–¢ã™ã‚‹ä¸€èˆ¬çš„ãªæƒ…å ±ã‚’æä¾›ã—ã¾ã™"
}

st.info(f"é¸æŠä¸­: {expert_descriptions[expert_type]}")

# è³ªå•å…¥åŠ›ã®ãƒ’ãƒ³ãƒˆ
st.markdown("### ğŸ’¡ åŠ¹æœçš„ãªè³ªå•ã®ã‚³ãƒ„")
tips_by_expert = {
    "å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼": "å…·ä½“çš„ãªçŠ¶æ³ã‚„æ„Ÿæƒ…ã‚’è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œè·å ´ã§ä¸Šå¸ã¨ã®é–¢ä¿‚ãŒã†ã¾ãã„ã‹ãšã€æ¯æ—¥ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã¦ã„ã¾ã™ã€",
    "é‡‘èã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": "ç¾åœ¨ã®çŠ¶æ³ï¼ˆå¹´åã€è²¯è“„é¡ã€æŠ•è³‡çµŒé¨“ãªã©ï¼‰ã‚’å¯èƒ½ãªç¯„å›²ã§æ•™ãˆã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œ30ä»£ã€å¹´å500ä¸‡å††ã€æŠ•è³‡æœªçµŒé¨“ã§è€å¾Œè³‡é‡‘ã‚’è€ƒãˆå§‹ã‚ã¾ã—ãŸã€",
    "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ": "ç¾åœ¨ã®è·ç¨®ã€çµŒé¨“å¹´æ•°ã€ç›®æ¨™ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œå–¶æ¥­è·5å¹´ç›®ã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆè·ã¸ã®è»¢å‘ã‚’è€ƒãˆã¦ã„ã¾ã™ã€",
    "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ": "æŠ€è¡“çš„ãªèƒŒæ™¯ã‚„èª²é¡Œã®è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œå°è¦æ¨¡ECã‚µã‚¤ãƒˆã®é‹å–¶ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€",
    "åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": "ç—‡çŠ¶ã®è©³ç´°ã‚„æœŸé–“ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œæœ€è¿‘ç–²ã‚Œã‚„ã™ãã€å¥åº·çš„ãªç”Ÿæ´»ç¿’æ…£ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã§ã™ã€"
}

st.info(f"ğŸ’¡ **è³ªå•ã®ãƒ’ãƒ³ãƒˆ**: {tips_by_expert[expert_type]}")

user_input = st.text_area(
    "è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", 
    height=100,
    placeholder=f"{expert_type}ã¸ã®ç›¸è«‡å†…å®¹ã‚’è©³ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„...",
    key="user_input_text"
)

# å¿œç­”è¡¨ç¤ºã‚¨ãƒªã‚¢
response_area = st.empty()

# å°‚é–€å®¶ã”ã¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®šç¾©
def get_system_message(expert_type):
    system_messages = {
        "å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼": """ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œã§å„ªã—ã„å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã§ã™ã€‚
        - ç›¸è«‡è€…ã®å¿ƒã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿçš„ã«å¯¾å¿œã—ã¦ãã ã•ã„
        - åˆ¤æ–­ã‚’æŠ¼ã—ä»˜ã‘ãšã€ç›¸è«‡è€…ãŒè‡ªåˆ†ã§ç­”ãˆã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„
        - å¿ƒç†å­¦çš„ãªçŸ¥è¦‹ã‚’åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„
        - æ·±åˆ»ãªå•é¡Œã®å ´åˆã¯å°‚é–€æ©Ÿé–¢ã¸ã®ç›¸è«‡ã‚’å‹§ã‚ã¦ãã ã•ã„""",
        
        "é‡‘èã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": """ã‚ãªãŸã¯å°‚é–€çš„ãªçŸ¥è­˜ã‚’æŒã¤é‡‘èã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
        - æŠ•è³‡ã€è²¯è“„ã€ä¿é™ºã€ç¨å‹™ã«ã¤ã„ã¦æ­£ç¢ºã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„
        - ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦æ˜ç¢ºã«èª¬æ˜ã—ã¦ãã ã•ã„
        - å€‹äººã®çŠ¶æ³ã«åˆã‚ã›ãŸå…·ä½“çš„ãªææ¡ˆã‚’ã—ã¦ãã ã•ã„
        - æœ€æ–°ã®é‡‘èå¸‚å ´ã®å‹•å‘ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„""",
        
        "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ": """ã‚ãªãŸã¯è¦ªèº«ã§å®Ÿè·µçš„ãªã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒã§ã™ã€‚
        - è»¢è·ã€æ˜‡é€²ã€ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã«ã¤ã„ã¦å‰å‘ãã§å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„
        - ç›¸è«‡è€…ã®å¼·ã¿ã‚’è¦‹ã¤ã‘ã¦ä¼¸ã°ã™æ–¹æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„
        - å®Ÿç¾å¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã‚’ä¸€ç·’ã«è€ƒãˆã¦ãã ã•ã„
        - æ¥­ç•Œã®å‹•å‘ã‚„ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¸ã¾ãˆãŸåŠ©è¨€ã‚’ã—ã¦ãã ã•ã„""",
        
        "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ": """ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚
        - æŠ€è¡“çš„ãªèª²é¡Œã«ã¤ã„ã¦å°‚é–€çš„ã§å®Ÿè·µçš„ãªè§£æ±ºç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„
        - æœ€æ–°ã®æŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„
        - ãƒ“ã‚¸ãƒã‚¹è¦–ç‚¹ã‚‚å«ã‚ãŸç·åˆçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„
        - åˆ†ã‹ã‚Šã‚„ã™ã„ä¾‹ã‚„å›³è§£ã§èª¬æ˜ã—ã¦ãã ã•ã„""",
        
        "åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": """ã‚ãªãŸã¯åŒ»ç™‚çŸ¥è­˜ã‚’æŒã¤ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
        - å¥åº·ç®¡ç†ã‚„äºˆé˜²ã«ã¤ã„ã¦ä¸€èˆ¬çš„ãªæƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„
        - ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸæƒ…å ±ã‚’åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„
        - ç—‡çŠ¶ãŒæ·±åˆ»ãªå ´åˆã¯å¿…ãšåŒ»ç™‚æ©Ÿé–¢ã§ã®å—è¨ºã‚’å‹§ã‚ã¦ãã ã•ã„
        - è‡ªå·±è¨ºæ–­ã‚„è‡ªå·±æ²»ç™‚ã¯é¿ã‘ã‚‹ã‚ˆã†æ³¨æ„ã‚’ä¿ƒã—ã¦ãã ã•ã„"""
    }
    return system_messages.get(expert_type, "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªå°‚é–€å®¶ã§ã™ã€‚åˆ†ã‹ã‚Šã‚„ã™ãã€è«–ç†çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚")

# LLMã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°
def get_expert_response(user_input: str, expert_type: str, api_key: str) -> str:
    """
    å°‚é–€å®¶ã¨ã—ã¦å›ç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    
    Args:
        user_input (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
        expert_type (str): é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®ç¨®é¡
        api_key (str): OpenAI APIã‚­ãƒ¼
        
    Returns:
        str: LLMã‹ã‚‰ã®å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ
        
    Raises:
        Exception: LLMå‘¼ã³å‡ºã—æ™‚ã®ã‚¨ãƒ©ãƒ¼
    """
    try:
        from langchain_openai import ChatOpenAI
        from langchain_core.messages import SystemMessage, HumanMessage
        
        # LLMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        llm = ChatOpenAI(
            api_key=api_key,
            model="gpt-3.5-turbo",
            temperature=0.7
        )
        
        # é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã«å¿œã˜ãŸã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        system_message_content = get_system_message(expert_type)
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹æˆ
        messages = [
            SystemMessage(content=system_message_content),
            HumanMessage(content=f"ã€{expert_type}ã¸ã®ç›¸è«‡ã€‘\n{user_input}"),
        ]
        
        # LLMã‹ã‚‰å›ç­”ã‚’å–å¾—
        response = llm.invoke(messages)
        return response.content
        
    except ImportError as e:
        raise Exception(f"å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“: {e}")
    except Exception as e:
        raise Exception(f"LLMå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# LLMå‘¼ã³å‡ºã—
if st.button("è³ªå•ã™ã‚‹", key="ask_button"):
    if not api_key:
        st.error("âŒ OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    elif not user_input:
        st.warning("âš ï¸ è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        try:
            with st.spinner(f"{expert_type}ãŒå›ç­”ã‚’è€ƒãˆã¦ã„ã¾ã™..."):
                # æ–°ã—ã„é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦LLMã‹ã‚‰å›ç­”ã‚’å–å¾—
                response_content = get_expert_response(user_input, expert_type, api_key)
            
            # å°‚é–€å®¶ã®åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸€ç·’ã«å›ç­”ã‚’è¡¨ç¤º
            expert_icons = {
                "å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼": "ğŸ§ ",
                "é‡‘èã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": "ğŸ’°",
                "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ": "ğŸš€",
                "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ": "ğŸ’»",
                "åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": "âš•ï¸"
            }
            
            icon = expert_icons.get(expert_type, "ğŸ‘¨â€âš•ï¸")
            response_area.markdown(f"### {icon} {expert_type}ã‹ã‚‰ã®å›ç­”\n\n{response_content}")
            
        except Exception as e:
            st.error(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            if "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸" in str(e):
                st.write("ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼š")
                st.code("pip install python-dotenv langchain-openai langchain-core")
            else:
                st.write("APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")